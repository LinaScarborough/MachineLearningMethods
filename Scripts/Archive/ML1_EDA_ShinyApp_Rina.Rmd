---
title: "ML1_EDA_ShinyApp"
output: html_document
date: "2024-05-13"
runtime: shiny
---
# 1. Libraries
This section loads the necessary R packages for data manipulation, visualization, and other tasks. If a package is not installed, it installs it first and then loads it.

```{r setup, include=FALSE}
# Load required libraries
# dplyr: For data manipulation
if (!require(dplyr, quietly = TRUE)) {
  install.packages("dplyr")
  library(dplyr)
}

# stringr: For string manipulation
if (!require(stringr, quietly = TRUE)) {
  install.packages("stringr")
  library(stringr)
}

# plotly: For interactive plots
if (!require(plotly, quietly = TRUE)) {
  install.packages("plotly")
  library(plotly)
}

# ggplot2: For data visualization
if (!require(ggplot2, quietly = TRUE)) {
  install.packages("ggplot2")
  library(ggplot2)
}

# readxl: For reading Excel files
if (!require(readxl, quietly = TRUE)) {
  install.packages("readxl")
  library(readxl)
}

# readr: For reading data
if (!require(readr, quietly = TRUE)) {
  install.packages("readr")
}
library(readr)

# treemapify: For creating treemaps
if (!require(treemapify, quietly = TRUE)) {
  install.packages("treemapify")
}
library(treemapify)

# scales: For scale functions
if (!require(scales, quietly = TRUE)) {
  install.packages("scales")
}
library(scales)

# patchwork: For combining ggplots
if (!require(patchwork, quietly = TRUE)) {
  install.packages("patchwork")
}
library(patchwork)

# gridExtra: For arranging plots
if (!require(gridExtra, quietly = TRUE)) {
  install.packages("gridExtra")
}
library(gridExtra)

# rcolorbrewer
if (!require(RColorBrewer, quietly = TRUE)) {
  install.packages("RColorBrewer")
}
library(RColorBrewer)

 # forcats
if (!require(forcats, quietly = TRUE)) {
  install.packages("forcats")
}
library(forcats)

 # shiny
if (!require(shiny, quietly = TRUE)) {
  install.packages("shiny")
}
library(shiny)

 # treemap
if (!require(treemap, quietly = TRUE)) {
  install.packages("treemap")
} 
library(treemap)

```

# 2. Dataset
This section for loading the dataset from the provided URL and displaying a summary of the data.

```{r loading, include=FALSE}
# Load dataset
df <- read.csv("Datasets/kul100od1001.csv")
```

Here are some of the key attributes:

StichtagDatJahr: Year of the data record
HalterId: Identifier for the pet owner
AlterV10Cd, AlterV10Lang, AlterV10Sort: Codes, descriptions, and sorting for the age group of the pet owner
SexCd, SexLang, SexSort: Codes, descriptions, and sorting for the gender of the pet owner
KreisCd, KreisLang, KreisSort: Codes, descriptions, and sorting for the district
QuarCd, QuarLang, QuarSort: Codes, descriptions, and sorting for the quarter
Rasse1Text, Rasse2Text: Primary and secondary breed texts of the pet
RasseMischlingCd, RasseMischlingLang, RasseMischlingSort: Codes, descriptions, and sorting for whether the pet is a mixed breed
RassentypCd, RassentypLang, RassentypSort: Codes, descriptions, and sorting for the type of breed
GebDatHundJahr: Year of birth of the pet
AlterVHundCd, AlterVHundLang, AlterVHundSort: Codes, descriptions, and sorting for the age group of the pet
SexHundCd, SexHundLang, SexHundSort: Codes, descriptions, and sorting for the gender of the pet
HundefarbeText: Color of the pet
AnzHunde: Number of dogs


# 3. Translation
In this section, we duplicate and rename the dataframe df as df_EN for the English version. Then, translations for column names in English are defined. Following this, a function is employed to replace multiple patterns at once for content translation. Patterns and replacements for content translation, including translations for age groups, sexes, breed types, and dog colors, are defined. After applying the translation function across all columns, dog colors are also translated.

```{r translation, include=FALSE}

# Duplicate and rename df for English version
df_EN <- df

# Define translations for column names in English
colnames(df_EN) <- c("KeyDateYear", "DataStatusCd", "OwnerId", "OwnerAgeGroupCd", "OwnerAgeGroup", "OwnerAgeGroupSort", "OwnerSexCd", "OwnerSex", "OwnerSexSort", "DistrictCd", "District", "DistrictSort", "QuarCd", "Quar", "QuarSort", "PrimaryBreed", "SecondaryBreed", "MixedBreedCd", "MixedBreed", "MixedBreedSort", "BreedTypeCd", "BreedType", "BreedTypeSort", "DogBirthYear", "DogAgeGroupCd", "DogAgeGroup", "DogAgeGroupSort", "DogSexCd", "DogSex", "DogSexSort", "DogColor", "NumberOfDogs")

# Define a function to replace multiple patterns at once
replace_patterns <- function(text, patterns, replacements) {
  for (i in seq_along(patterns)) {
    text <- str_replace_all(text, patterns[i], replacements[i])
  }
  return(text)
}

# Define patterns and replacements for content translation
patterns <- c("- bis ", "-Jährige", "männlich", "weiblich", "Keine", "Unbekannt", "Rassehund", "Mischling, beide Rassen bekannt", "Mischling, sekundäre Rasse unbekannt", "Mischling, beide Rassen unbekannt", "Kleinwüchsig", "Rassentypenliste I", "Rassentypenliste II")
replacements <- c(" to ", " years old", "male", "female", "none", "Unknown", "Pedigree dog", "Mixed breed, both breeds known", "Mixed breed, secondary breed unknown", "Mixed breed, both breeds unknown", "Small stature", "Breed type list I", "Breed type list II")

# Apply the function across all columns
df_EN[] <- lapply(df_EN, function(x) replace_patterns(x, patterns, replacements))

# Color translation - can be further customized based on your dataset
color_patterns <- c("schwarz", "braun", "weiss", "grau", "silber", "rot", "gelb", "hell", "dunkel", "gestromt", "schimmel", "zweifarbig", "dreifarbig", "vierfarbig", "gemischt", "meliert", "hirschrot mit Maske", "löwenfarbig")
color_replacements <- c("black", "brown", "white", "gray", "silver", "red", "yellow", "light", "dark", "brindle", "mold", "2 colors", "3 colors", "4 colors", "mixed", "mottled", "stag red with mask", "lion-colored")

# Translate dog colors
df_EN$DogColor <- replace_patterns(df_EN$DogColor, color_patterns, color_replacements)

# Optional: Print unique values to check the translations
print(unique(df_EN$MixedBreed))
print(unique(df_EN$BreedType))
print(unique(df_EN$DogColor))

View(df_EN)

write.csv(df_EN, "df_EN.csv", row.names = FALSE)
```


# 4. Unique Owner IDs
In the following R code snippet, we implement a method to distinguish unique OwnerId values within our dataset. By marking the initial occurrence of each OwnerId as unique, we facilitate further analyses that may require the identification of distinct entries. 

```{r df_unique_OwnerId, include=TRUE}
df_EN$unique_OwnerId <- !duplicated(df_EN$OwnerId)
View(df_EN)

```

# 5. Refined Dataset
The R code below demonstrates the process of extracting a subset of relevant columns from our comprehensive dataset df_EN, thereby creating a streamlined DataFrame, new_df. This subset includes essential fields such as KeyDateYear, OwnerId, and details regarding the dogs such as PrimaryBreed and DogBirthYear. Additionally, the code converts the NumberOfDogs column from its original format to a numeric type, ensuring that subsequent data analysis can utilize numerical operations. 

```{r new_df, include=TRUE}
# Create a new DataFrame with selected columns and convert 'NumberOfDogs' to numeric
new_df <- df_EN %>%
  select(KeyDateYear, OwnerId, OwnerAgeGroup, OwnerSex, DistrictSort, QuarCd, PrimaryBreed, SecondaryBreed, MixedBreed, BreedType, DogBirthYear,    DogSex, NumberOfDogs, unique_OwnerId) %>%
  mutate(NumberOfDogs = as.numeric(as.character(NumberOfDogs)))

View(new_df)

```

# 6. ShinyApp

## 6.1. Unique owners by year, by age group and by gender

```{r shiny, unique owners by year, by age group and by gender, include=TRUE}

# Define UI
ui <- fluidPage(
    titlePanel("Unique Owner IDs by Age Group and Gender"),
    sidebarLayout(
        sidebarPanel(
            selectInput("selectedYear", "Select Year:", 
                        choices = unique(new_df$KeyDateYear)),
            selectInput("selectedGender", "Select Gender:",
                        choices = c("All" = "all", "Male" = "male", "Female" = "female")),
            helpText("Displays unique owner IDs by age group and selected gender for the chosen year.")
        ),
        mainPanel(
            plotOutput("genderPlot")
        )
    )
)

# Define server logic
server <- function(input, output) {
    output$genderPlot <- renderPlot({
        # Aggregate unique Owner IDs by Age Group, Year, and Gender
        if (input$selectedGender == "all") {
            # Sum across both genders
            unique_owner_counts_gender <- new_df %>%
                group_by(KeyDateYear, OwnerAgeGroup) %>%
                summarise(UniqueOwnerCountGender = n_distinct(OwnerId), .groups = 'drop')
        } else {
            # Filter for a specific gender
            unique_owner_counts_gender <- new_df %>%
                group_by(KeyDateYear, OwnerAgeGroup, OwnerSex) %>%
                summarise(UniqueOwnerCountGender = n_distinct(OwnerId), .groups = 'drop') %>%
                filter(OwnerSex == input$selectedGender)
        }

        # Adjust factor levels
        unique_owner_counts_gender$OwnerAgeGroup <- factor(unique_owner_counts_gender$OwnerAgeGroup,
                                                           levels = unique(new_df$OwnerAgeGroup[order(new_df$OwnerAgeGroup)]))

        # Filter data for the specific year
        data_for_year_gender <- filter(unique_owner_counts_gender, KeyDateYear == as.numeric(input$selectedYear))
        
        # Create the plot
        ggplot(data_for_year_gender, aes(x = OwnerAgeGroup, y = UniqueOwnerCountGender, fill = OwnerAgeGroup)) +
            geom_bar(stat = "identity", position = "dodge") +
            geom_text(aes(label = UniqueOwnerCountGender), vjust = -0.5, color = "black", size = 3.5) +
            geom_hline(yintercept = c(100, 500, 1000, 1500), linetype = "dashed", color = "red") +
            theme_minimal() +
            labs(title = paste("Unique Owner IDs by Age Group and", input$selectedGender, "in", input$selectedYear),
                 x = "Owner Age Group",
                 y = "Count of Unique Owner IDs") +
            scale_fill_brewer(palette = "Paired") +
            scale_y_continuous(limits = c(0, max(2000, max(data_for_year_gender$UniqueOwnerCountGender) + 500)), breaks = seq(0, 2000, by = 500)) +
            scale_x_discrete(labels = function(x) {
                x <- gsub("[0-9]+ to [0-9]+ years old", "", x)
                gsub("Unknown", "", x)
            })
    })
}

shinyApp(ui = ui, server = server)

```

## 6.2. Heatmap of total number of dogs per year by owner's Gender

```{r shiny, heatmap, include=TRUE}

ui <- fluidPage(
    titlePanel("Heatmap of Unique Owners by Gender and Age Group"),
    sidebarLayout(
        sidebarPanel(
            selectInput("selectedYear", "Select Year:", 
                        choices = unique(new_df$KeyDateYear)),
            helpText("Displays a heatmap of unique owner counts by age group and gender for the selected year.")
        ),
        mainPanel(
            plotOutput("ownerHeatmap")
        )
    )
)

server <- function(input, output) {
    output$ownerHeatmap <- renderPlot({
        # Prepare the data
        owner_counts <- new_df %>%
          select(KeyDateYear, OwnerAgeGroup, OwnerSex, OwnerId) %>%
          distinct(KeyDateYear, OwnerAgeGroup, OwnerSex, OwnerId) %>%
          group_by(KeyDateYear, OwnerAgeGroup, OwnerSex) %>%
          summarize(UniqueOwners = n(), .groups = 'drop')

        # Filter data for the specific year selected by user
        yearly_data <- filter(owner_counts, KeyDateYear == as.numeric(input$selectedYear))

        # Create the heatmap
        p <- ggplot(yearly_data, aes(x = OwnerSex, y = OwnerAgeGroup, fill = UniqueOwners)) +
            geom_tile() +
            scale_fill_gradientn(colors = brewer.pal(11, "Spectral"), limits = c(0, max(yearly_data$UniqueOwners, na.rm = TRUE)), name = "Total Owners") +
            theme_minimal() +
            labs(title = paste("Heatmap of Unique Owners by Gender and Age Group in", input$selectedYear),
                 x = "Owner's Gender",
                 y = "Owner's Age Group",
                 fill = "Number of Unique Owners") +
            theme(axis.text.y = element_text(angle = 45, hjust = 1))
        
        # Return the plot
        p
    })
}

shinyApp(ui = ui, server = server)

```

## 6.3. Total Count of Dogs by District

```{r shiny, total count of dogs by district, include=TRUE}

ui <- fluidPage(
    titlePanel("Total Count of Dogs by District"),
    sidebarLayout(
        sidebarPanel(
            selectInput("selectedYear", "Select Year:", 
                        choices = unique(new_df$KeyDateYear)),
            helpText("Displays the total count of dogs by district for the selected year.")
        ),
        mainPanel(
            plotOutput("dogPlot")
        )
    )
)

server <- function(input, output) {
    output$dogPlot <- renderPlot({
        # Filter and aggregate data based on the selected year, excluding District 15
        yearly_data <- new_df %>%
            filter(KeyDateYear == as.numeric(input$selectedYear), !is.na(DistrictSort), DistrictSort != "15") %>%
            group_by(DistrictSort) %>%
            summarize(TotalDogs = sum(NumberOfDogs), .groups = 'drop') %>%
            arrange(desc(TotalDogs))  # Arrange by TotalDogs in descending order

        # Create the bar plot
        p <- ggplot(yearly_data, aes(x = reorder(DistrictSort, -TotalDogs), y = TotalDogs, fill = DistrictSort)) +
            geom_col() +
            geom_text(aes(label = TotalDogs), vjust = -0.3, color = "black", size = 3.5) +  # Add dog counts on bars
            geom_hline(yintercept = c(100, 500, 1000, 1500), linetype = "dashed", color = "red") +
            scale_fill_viridis_d(name = "District") +
            scale_y_continuous(limits = c(0, 2000), breaks = seq(0, 2000, by = 500)) +
            theme_minimal() +
            labs(title = paste("Total Count of Dogs by District in", input$selectedYear),
                 x = "District",
                 y = "Total Number of Dogs") +
            theme(axis.text.x = element_text(angle = 90, hjust = 1),
                  legend.position = "none")
        
        return(p)
    })
}

shinyApp(ui = ui, server = server)

```
## 6.4. Total Count of Dogs by district with Dogs'gender

```{r shiny, total count of dogs by district and dogs gender, include=TRUE}

ui <- fluidPage(
    titlePanel("Total Count of Dogs by District and Gender"),
    sidebarLayout(
        sidebarPanel(
            selectInput("selectedYear", "Select Year:", 
                        choices = unique(new_df$KeyDateYear)),
            selectInput("selectedGender", "Select Gender:",
                        choices = c("All" = "all", "Male" = "male", "Female" = "female")),
            helpText("Displays the total count of dogs by district and gender for the selected year, ordered by total count.")
        ),
        mainPanel(
            plotOutput("dogPlot")
        )
    )
)

server <- function(input, output) {
    output$dogPlot <- renderPlot({
        # Filter data based on the selected year and exclude District 15
        filtered_data <- new_df %>%
            filter(KeyDateYear == as.numeric(input$selectedYear), 
                   !is.na(DistrictSort), 
                   DistrictSort != "15")  # Exclude District 15

        # Apply gender filter if not "All"
        if (input$selectedGender != "all") {
            filtered_data <- filtered_data %>%
                filter(DogSex == input$selectedGender)
        }

        # Aggregate data by district and optionally by gender
        yearly_data <- filtered_data %>%
            group_by(DistrictSort, DogSex) %>%
            summarize(TotalDogs = sum(NumberOfDogs), .groups = 'drop') %>%
            ungroup() %>%
            arrange(desc(TotalDogs))  # Order by total dogs in descending order

        # Create the bar plot
        p <- ggplot(yearly_data, aes(x = reorder(DistrictSort, -TotalDogs), y = TotalDogs, fill = DogSex)) +
            geom_col(position = position_dodge()) +
            geom_text(aes(label = TotalDogs), vjust = -0.3, color = "black", size = 3.5) +  # Add dog counts on bars
            geom_hline(yintercept = c(100, 500), linetype = "dashed", color = "red") +
            scale_fill_manual(values = c("male" = "green", "female" = "violet")) + 
            scale_y_continuous(limits = c(0, 800), breaks = seq(0, 800, by = 100)) +
            theme_minimal() +
            labs(title = paste("Total Count of Dogs by District and Dog gender in", input$selectedYear),
                 x = "District",
                 y = "Total Number of Dogs") +
            theme(axis.text.x = element_text(angle = 90, hjust = 1),
                  legend.position = "bottom")

        return(p)
    })
}

shinyApp(ui = ui, server = server)

```
## 6.5. By district and Unique Owners' gender

```{r shiny, total count of dogs by unique owners gender, include=TRUE}

ui <- fluidPage(
    titlePanel("Total Count of Dogs by District and Owner's Gender"),
    sidebarLayout(
        sidebarPanel(
            selectInput("selectedYear", "Select Year:", choices = unique(new_df$KeyDateYear)),
            selectInput("selectedGender", "Select Owner's gender:", choices = c("Male" = "male", "Female" = "female")),
            helpText("Displays the total count of dogs by district and gender for the selected year.")
        ),
        mainPanel(
            plotOutput("dogPlot")
        )
    )
)

server <- function(input, output) {
    output$dogPlot <- renderPlot({
        # Filter data based on the selected year and exclude District 15
        filtered_data <- new_df %>%
            filter(KeyDateYear == as.numeric(input$selectedYear), !is.na(DistrictSort), DistrictSort != "")

        # If 'All' is not selected, further filter by gender
        if (input$selectedGender != "All") {
            filtered_data <- filtered_data %>%
                filter(OwnerSex == input$selectedGender)
        }

        # Aggregate data by district and optionally by gender
        aggregated_data <- filtered_data %>%
            group_by(DistrictSort) %>%
            summarize(TotalDogs = sum(NumberOfDogs), .groups = 'drop') %>%
            arrange(desc(TotalDogs))

        # Create the plot using reordered DistrictSort based on TotalDogs
        p <- ggplot(aggregated_data, aes(x = reorder(DistrictSort, -TotalDogs), y = TotalDogs, fill = DistrictSort)) +
            geom_col() +
            geom_text(aes(label = TotalDogs), vjust = -0.3) +
            geom_hline(yintercept = c(100, 500, 1000, 1500), linetype = "dashed", color = "red") +
            scale_fill_viridis_d() +
            theme_minimal() +
            labs(title = paste("Total Count of Dogs by District in", input$selectedYear,
                               if(input$selectedGender != "All") paste("—", input$selectedGender) else ""),
                 x = "District",
                 y = "Total Number of Dogs") +
            theme(axis.text.x = element_text(angle = 45, hjust = 1),
                  legend.position = "none")  # Optionally remove the legend

        return(p)
    })
}

shinyApp(ui = ui, server = server)

```

## 6.6. By district and Breed Type

### version 1

```{r shiny, total count of dogs by breedtype, include=TRUE}

# Define UI
ui <- fluidPage(
    titlePanel("Total Count of Dogs by District and Breed Type"),
    sidebarLayout(
        sidebarPanel(
            selectInput("selectedYear", "Select Year:", choices = unique(new_df$KeyDateYear)),
            selectInput("selectedBreedType", "Select Breed Type:", 
                        choices = c("All" = "All", unique(new_df$BreedType))),
            checkboxInput("includeUnknown", "Include Unknown Breeds", value = FALSE),
            helpText("Displays the total count of dogs by district and selected breed type for the selected year, excluding District 15.")
        ),
        mainPanel(
            plotOutput("breedPlot")
        )
    )
)

# Define server logic
server <- function(input, output) {
    output$breedPlot <- renderPlot({
        # Filter data based on the selected year and exclude District 15
        filtered_data <- new_df %>%
            filter(KeyDateYear == as.numeric(input$selectedYear), DistrictSort != "15", !is.na(DistrictSort))
        
        # Convert DistrictSort to a factor with levels from 1 to 12
        filtered_data$DistrictSort <- factor(filtered_data$DistrictSort, levels = as.character(1:12))

        # Optionally include/exclude unknown breeds based on checkbox input
        if (!input$includeUnknown) {
            filtered_data <- filtered_data %>%
                filter(BreedType != "Unknown")
        }

        # Filter by selected breed type if not 'All'
        if (input$selectedBreedType != "All") {
            filtered_data <- filtered_data %>%
                filter(BreedType == input$selectedBreedType)
        }

        # Aggregate data by district and breed type
        breed_data <- filtered_data %>%
            group_by(DistrictSort, BreedType) %>%
            summarize(TotalDogs = sum(NumberOfDogs), .groups = 'drop') %>%
            arrange(DistrictSort, desc(TotalDogs)) %>%
            group_by(DistrictSort) %>%
            top_n(10, wt = TotalDogs) %>%
            ungroup()

        # Generate the plot
        p <- ggplot(breed_data, aes(x = DistrictSort, y = TotalDogs, fill = BreedType)) +
            geom_col(position = "stack") +
            scale_fill_viridis_d() +
            geom_hline(yintercept = c(100, 500, 1000, 1500), linetype = "dashed", color = "red") +
            scale_y_continuous(limits = c(0, max(1700, max(breed_data$TotalDogs, na.rm = TRUE))), breaks = seq(0, 1700, by = 100)) +
            theme_minimal() +
            labs(title = paste("Top 10 Breed Types by Total Count of Dogs in", input$selectedYear),
                 x = "District",
                 y = "Total Number of Dogs") +
            theme(axis.text.x = element_text(angle = 45, hjust = 1))

        return(p)
    })
}

# Run the application 
shinyApp(ui = ui, server = server)
```
### version 2

```{r shiny, total count of dogs by breedtype 2, include=TRUE}

# Define UI
ui <- fluidPage(
    titlePanel("Total Count of Dogs by District and Breed Type"),
    sidebarLayout(
        sidebarPanel(
            selectInput("selectedYear", "Select Year:", choices = unique(new_df$KeyDateYear)),
            checkboxInput("includeUnknown", "Include Unknown Breeds", value = FALSE),
            helpText("Displays the total count of dogs by district and breed type for the selected year.")
        ),
        mainPanel(
            plotOutput("breedPlot")
        )
    )
)

# Define server logic
server <- function(input, output) {
    output$breedPlot <- renderPlot({
        # Filter data based on the selected year and handle unknown breed types
        filtered_data <- new_df %>%
            filter(KeyDateYear == as.numeric(input$selectedYear), DistrictSort != "15", !is.na(DistrictSort))
        
        # Convert DistrictSort to a factor with levels from 1 to 12
        filtered_data$DistrictSort <- factor(filtered_data$DistrictSort, levels = as.character(1:12))

        if (!input$includeUnknown) {
            filtered_data <- filtered_data %>%
                filter(BreedType != "Unknown")
        }

        # Summarize total dogs by district and breed type
        breed_data <- filtered_data %>%
            group_by(DistrictSort, BreedType) %>%
            summarize(TotalDogs = sum(NumberOfDogs), .groups = 'drop') %>%
            ungroup() %>%
            mutate(Position = as.numeric(DistrictSort))  # Position adjustment

        # Create the plot with bars and points
        p <- ggplot() +
            geom_bar(data = breed_data, aes(x = DistrictSort, y = TotalDogs, fill = DistrictSort), stat = "identity") +
            geom_point(data = breed_data, aes(x = Position, y = TotalDogs, color = BreedType, shape = BreedType), size = 3, position = position_jitterdodge(jitter.width = 0.2)) +
            geom_hline(yintercept = c(100, 500, 1000, 1500), linetype = "dashed", color = "red") +
            scale_fill_viridis_d(name = "District", guide = "none") +
            scale_shape_manual(values = seq(1, 20)) +
            scale_size(range = c(1, 6)) +
            scale_y_continuous(limits = c(0, 2000), breaks = seq(0, 2000, by = 500)) +
            theme_minimal() +
            labs(title = paste("Total Count of Dogs by District in", input$selectedYear),
                 subtitle = "Points indicate count by breed type",
                 x = "District",
                 y = "Total Count of Dogs") +
            theme(axis.text.x = element_text(angle = 90, hjust = 1))

        return(p)
    })
}

# Run the application
shinyApp(ui = ui, server = server)

```
## 6.7. By district, Breed Type and Dogs's Gender

```{r shiny, total count of dogs by breedtype and dogs gender, include=TRUE}

# Define UI for the application
ui <- fluidPage(
    titlePanel("Total Count of Dogs by District, Breed, and Gender"),
    sidebarLayout(
        sidebarPanel(
            selectInput("selectedYear", "Select Year:", choices = unique(new_df$KeyDateYear)),
            selectInput("selectedBreedType", "Select Breed Type:", choices = c("All", unique(new_df$BreedType))),
            selectInput("selectedGender", "Select Gender:", choices = c("All", "Male" = "male", "Female" = "female")),
            checkboxInput("includeUnknown", "Include Unknown Breeds", value = FALSE),
            helpText("Displays the total count of dogs by district, breed type, and gender for the selected year.")
        ),
        mainPanel(
            plotOutput("dogPlot")
        )
    )
)

# Define server logic
server <- function(input, output) {
    output$dogPlot <- renderPlot({
        # Filter data based on the selected year
        filtered_data <- new_df %>%
            filter(KeyDateYear == as.numeric(input$selectedYear), DistrictSort != "15", !is.na(DistrictSort))
        
        # Convert DistrictSort to a factor with levels from 1 to 12
        filtered_data$DistrictSort <- factor(filtered_data$DistrictSort, levels = as.character(1:12))

        # Optionally include/exclude unknown breeds
        if (!input$includeUnknown) {
            filtered_data <- filtered_data %>%
                filter(BreedType != "Unknown")
        }

        # Filter by selected breed type if not 'All'
        if (input$selectedBreedType != "All") {
            filtered_data <- filtered_data %>%
                filter(BreedType == input$selectedBreedType)
        }

        # Filter by selected gender if not 'All'
        if (input$selectedGender != "All") {
            filtered_data <- filtered_data %>%
                filter(DogSex == input$selectedGender)
        }

        # Calculate total number of dogs per district
        breed_data <- filtered_data %>%
            group_by(DistrictSort, BreedType, DogSex) %>%
            summarize(TotalDogs = sum(NumberOfDogs), .groups = 'drop') %>%
            mutate(Position = as.numeric(DistrictSort) + ifelse(DogSex == "female", -0.2, 0.2))  # Position adjustment for clarity

        # Generate the plot
        p <- ggplot() +
            geom_bar(data = breed_data, aes(x = DistrictSort, y = TotalDogs, fill = DistrictSort), stat = "identity") +
            geom_point(data = breed_data, aes(x = Position, y = TotalDogs, color = DogSex, shape = BreedType), size = 3, position = position_jitterdodge(jitter.width = 0.1)) +
            geom_hline(yintercept = c(100, 500, 1000, 1500), linetype = "dashed", color = "red") +
            scale_fill_viridis_d(name = "District", guide = "none") +
            scale_color_manual(values = c("female" = "pink", "male" = "blue")) +
            scale_shape_manual(values = seq(1, 20)) +
            scale_y_continuous(limits = c(0, 2000), breaks = seq(0, 2000, by = 500)) +
            theme_minimal() +
            labs(title = paste("Total Count of Dogs by District, Breed, and Gender in", input$selectedYear),
                 subtitle = "Bar: Total Count | Points: Count by Breed and Gender",
                 x = "District",
                 y = "Total Count of Dogs") +
            theme(axis.text.x = element_text(angle = 90, hjust = 1))

        return(p)
    })
}

# Run the application
shinyApp(ui = ui, server = server)

```

##6.8. Top dog breeds by year

```{r shiny, top dog breeds by year, include=TRUE}

# Function to assign colors to PrimaryBreed
assign_colors <- function(data) {
    n_breeds <- length(unique(data$PrimaryBreed))
    palette <- scales::hue_pal()(n_breeds)
    breed_color_map <- setNames(palette, unique(data$PrimaryBreed))
    return(breed_color_map)
}


ui <- fluidPage(
    titlePanel("Top dog breeds by year"),
    sidebarLayout(
        sidebarPanel(
            selectInput("selectedYear", "Select Year:", choices = unique(new_df$KeyDateYear)),
            checkboxInput("includeUnknown", "Include Unknown Breeds", value = TRUE),
            helpText("Displays top dog breeds by year")
        ),
        mainPanel(
            plotOutput("breedPlot")
        )
    )
)

server <- function(input, output) {
    output$breedPlot <- renderPlot({
        # Filter data based on the selected year
        filtered_data <- new_df %>%
            filter(KeyDateYear == as.numeric(input$selectedYear))

        # Optionally exclude unknown breeds
        if (!input$includeUnknown) {
            filtered_data <- filtered_data %>%
                filter(PrimaryBreed != "Unknown")
        }

        # Aggregate data by PrimaryBreed
        breed_data <- filtered_data %>%
            group_by(PrimaryBreed) %>%
            summarize(TotalDogs = sum(NumberOfDogs), .groups = 'drop') %>%
            arrange(desc(TotalDogs)) %>%
            slice_max(order_by = TotalDogs, n = 10)

        # Check if breed data is empty
        if (nrow(breed_data) == 0) {
            return(ggplot() +
                   labs(title = "No data available for the selected year or criteria",
                        x = "", y = "") +
                   theme_minimal())
        }

        # Assign colors to PrimaryBreed
        breed_color_map <- assign_colors(breed_data)

        # Generate the plot
        p <- ggplot(breed_data, aes(x = reorder(PrimaryBreed, TotalDogs), y = TotalDogs, fill = PrimaryBreed)) +
            geom_col() +
            scale_fill_manual(values = breed_color_map) +
            geom_hline(yintercept = c(250, 500, 750, 1000), linetype = "dashed", color = "red") +
            scale_y_continuous(limits = c(0, max(1250, max(breed_data$TotalDogs, na.rm = TRUE))), breaks = seq(0, max(750, max(breed_data$TotalDogs, na.rm = TRUE)), by = 250)) +
            theme_minimal() +
            labs(title = paste("Top 10 Primary Breeds", input$selectedYear),
                 x = "Primary Breed", y = "Total Number of Dogs") +
            theme(axis.text.x = element_text(angle = 45, hjust = 1))

        return(p)
    })
}

shinyApp(ui = ui, server = server)

```
##6.9. Top dog breeds by district

```{r shiny, primary breeds by district, include=TRUE}
  
ui <- fluidPage(
    titlePanel("Dog Breed Trends by District"),
    sidebarLayout(
        sidebarPanel(
            selectInput("selectedYear", "Select Year:", choices = unique(new_df$KeyDateYear)),
            checkboxInput("includeUnknown", "Include Unknown Breeds", value = TRUE),
            helpText("Displays top dog breeds by district for the selected year.")
        ),
        mainPanel(
            plotOutput("breedPlot")
        )
    )
)

server <- function(input, output) {
    output$breedPlot <- renderPlot({
        # Filter data based on selected year and exclude District 15
        filtered_data <- new_df %>%
            filter(KeyDateYear == as.numeric(input$selectedYear), DistrictSort != "15")

        # Optionally exclude unknown breeds based on checkbox input
        if (!input$includeUnknown) {
            filtered_data <- filtered_data %>%
                filter(PrimaryBreed != "Unknown")
        }

        # Ensure DistrictSort is a factor with levels correctly ordered
        filtered_data$DistrictSort <- factor(filtered_data$DistrictSort, levels = as.character(1:12))

        # Aggregate data
        yearly_data <- filtered_data %>%
            group_by(DistrictSort, PrimaryBreed) %>%
            summarize(TotalDogs = sum(NumberOfDogs), .groups = 'drop') %>%
            arrange(DistrictSort, desc(TotalDogs)) %>%
            group_by(DistrictSort) %>%
            top_n(5, wt = TotalDogs) %>%
            ungroup()

        # Assign colors to PrimaryBreed
        breed_color_map <- assign_colors(yearly_data)

        # Generate the plot
        p <- ggplot(yearly_data, aes(x = DistrictSort, y = TotalDogs, fill = PrimaryBreed)) +
            geom_col(position = "stack") +
            scale_fill_manual(values = breed_color_map) +
            geom_hline(yintercept = c(150, 300, 450, 600), linetype = "dashed", color = "red") +
            scale_y_continuous(limits = c(0, max(600, max(yearly_data$TotalDogs))), breaks = seq(0, max(600, max(yearly_data$TotalDogs)), by = 300)) +
            theme_minimal() +
            labs(title = paste("Top 5 Primary Breeds by Total Count of Dogs in", input$selectedYear),
                 x = "District",
                 y = "Total Number of Dogs") +
            theme(axis.text.x = element_text(angle = 90, hjust = 1))

        return(p)
    })
}

shinyApp(ui = ui, server = server)
```



```{r shiny, all primary breeds by district, include=TRUE}

# Function to assign colors to PrimaryBreed
assign_colors <- function(data) {
    n_breeds <- length(unique(data$PrimaryBreed))
    palette <- scales::hue_pal()(n_breeds)
    breed_color_map <- setNames(palette, unique(data$PrimaryBreed))
    return(breed_color_map)
}

# Define UI for the application
ui <- fluidPage(
    titlePanel("Top Dog Breeds by District"),
    sidebarLayout(
        sidebarPanel(
            selectInput("selectedYear", "Select Year:", choices = unique(new_df$KeyDateYear)),
            selectInput("selectedBreed", "Select Breed Type:", choices = NULL),  # Dynamically populated
            checkboxInput("includeUnknown", "Include Unknown Breeds", value = FALSE),
            helpText("Displays the total count of dogs by district and selected breed type for the selected year.")
        ),
        mainPanel(
            plotOutput("breedPlot")
        )
    )
)

# Define server logic required to draw a plot
server <- function(input, output, session) {
    # Observe the selected year to update breed type options
    observe({
        year_data <- new_df %>%
            filter(KeyDateYear == as.numeric(input$selectedYear), !is.na(PrimaryBreed), DistrictSort != "15") %>%
            group_by(PrimaryBreed) %>%
            summarize(TotalDogs = sum(NumberOfDogs), .groups = 'drop') %>%
            arrange(desc(TotalDogs)) %>%
            slice_max(order_by = TotalDogs, n = 10)

        breed_choices <- c("All", year_data$PrimaryBreed)
        updateSelectInput(session, "selectedBreed", choices = breed_choices, selected = breed_choices[1])
    })

    output$breedPlot <- renderPlot({
        # Filter data based on the selected year and exclude District 15
        filtered_data <- new_df %>%
            filter(KeyDateYear == as.numeric(input$selectedYear), DistrictSort != "15", !is.na(DistrictSort))

        # Optionally exclude unknown breeds based on checkbox input
        if (!input$includeUnknown) {
            filtered_data <- filtered_data %>%
                filter(PrimaryBreed != "Unknown")
        }

        # If 'All' is not selected for breed type, further filter by selected breed type
        if (input$selectedBreed != "All") {
            filtered_data <- filtered_data %>%
                filter(PrimaryBreed == input$selectedBreed)
        }
        
        # Ensure DistrictSort is a factor with levels correctly ordered
        filtered_data$DistrictSort <- factor(filtered_data$DistrictSort, levels = as.character(1:12))

        # Aggregate data by district and breed type
        aggregated_data <- filtered_data %>%
            group_by(DistrictSort, PrimaryBreed) %>%
            summarize(TotalDogs = sum(NumberOfDogs), .groups = 'drop') %>%
            arrange(DistrictSort, desc(TotalDogs)) %>%
            group_by(DistrictSort) %>%
            top_n(5, wt = TotalDogs) %>%
            ungroup()

        # Assign colors to PrimaryBreed
        breed_color_map <- assign_colors(aggregated_data)

        # Generate the plot
        p <- ggplot(aggregated_data, aes(x = DistrictSort, y = TotalDogs, fill = PrimaryBreed)) +
            geom_col(position = "stack") +
            scale_fill_manual(values = breed_color_map) +
            geom_hline(yintercept = c(100, 250, 500), linetype = "dashed", color = "red") +
            scale_y_continuous(limits = c(0, max(500, max(aggregated_data$TotalDogs))), breaks = seq(0, 500, by = 100)) +
            theme_minimal() +
            labs(title = paste("Top Breeds by Total Count of Dogs in", input$selectedYear),
                 x = "District",
                 y = "Total Number of Dogs") +
            theme(axis.text.x = element_text(angle = 45, hjust = 1))

        return(p)
    })
}

# Run the application 
shinyApp(ui = ui, server = server)

```
```{r shiny, treemap, primary breeds by district, include=TRUE}

ui <- fluidPage(
    titlePanel("Dog Breed Trends by District"),
    sidebarLayout(
        sidebarPanel(
            selectInput("selectedYear", "Select Year:", choices = unique(new_df$KeyDateYear)),
            checkboxInput("includeUnknown", "Include Unknown Breeds", value = TRUE),
            helpText("Displays top dog breeds by district for the selected year.")
        ),
        mainPanel(
            plotOutput("breedPlot")
        )
    )
)

server <- function(input, output) {
    output$breedPlot <- renderPlot({
        # Filter data based on selected year and exclude District 15
        filtered_data <- new_df %>%
            filter(KeyDateYear == as.numeric(input$selectedYear), DistrictSort != "15")

        # Optionally exclude unknown breeds based on checkbox input
        if (!input$includeUnknown) {
            filtered_data <- filtered_data %>%
                filter(PrimaryBreed != "Unknown")
        }

        # Aggregate data
        yearly_data <- filtered_data %>%
            group_by(DistrictSort, PrimaryBreed) %>%
            summarize(TotalDogs = sum(NumberOfDogs), .groups = 'drop') %>%
            arrange(DistrictSort, desc(TotalDogs)) %>%
            group_by(DistrictSort) %>%
            top_n(5, wt = TotalDogs) %>%
            ungroup()

        # Plotting the treemap
        treemap(yearly_data,
                index = c("DistrictSort", "PrimaryBreed"),
                vSize = "TotalDogs",
                vColor = "TotalDogs",
                title = paste("Top 5 Primary Breeds by Total Count of Dogs in", input$selectedYear),
                palette = "Spectral")
    })
}

shinyApp(ui = ui, server = server)

```




